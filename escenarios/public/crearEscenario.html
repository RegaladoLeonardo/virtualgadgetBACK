<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/diagPStyle.css">
  <title>Crear Escenario</title>
</head>
<body>
  <div class="interact-container">
    <div class="left-side">
      <h3>Spectre</h3>
      <h4>Escenarios</h4>
      <form>
        <input name="texto" type="text" id="textoFig" class="texto" placeholder="Ingrese el texto" required pattern="^(?:3[01]|[12][0-9]|0?[1-9])([\-/.])(0?[1-9]|1[1-2])\1\d{4}$" maxlength="30">
        <select name="tipo" id="forma">
          <option value="proceso">proceso</option>
          <option value="limites">limites</option>
          <option value="decision">decision</option>
          <option value="entradaSalida">entradaSalida</option>
        </select>
        <button type="button" class="boton" onclick="addFig()">Agregar</button>
      </form>
      <form>
        <select name="valorFlecha" id="valorFl">
          <option value="Si">Verdadero</option>
          <option value="No">Falso</option>
        </select>
        <button type="button" class="boton" onclick="addArrow()">Flecha</button>
      </form>
      <form action="/addEscenario" method="post">
        <input name="nombre" id="nombre" required pattern="^(?:3[01]|[12][0-9]|0?[1-9])([\-/.])(0?[1-9]|1[1-2])\1\d{4}$" maxlength="30">
        <input name="descripcion" id="descripcion" required pattern="^(?:3[01]|[12][0-9]|0?[1-9])([\-/.])(0?[1-9]|1[1-2])\1\d{4}$" maxlength="100">
        <input type="text" id="desde" name="desde" style="display: none;">
        <input type="text" id="hacia" name="hacia" style="display: none;">
        <input type="text" id="tipoF" name="tipoF" style="display: none;">
        <input type="text" id="texto" name="texto" style="display: none;">
        <input type="text" id="posx" name="posx" style="display: none;">
        <input type="text" id="posy" name="posy" style="display: none;">
        <input type="text" id="ids" name="ids" style="display: none;">
        <button type="submit" onclick="prepararCamp()">Guardar</button>
      </form>
    </div>
    <canvas width="1000" height="800" id="lienzo"></canvas>
  </div>
  <script>
    var cv, cx, objetos,flecha = false, objetoActual = null,elem1=-1,elem2=-1,flechas,valorFle='';
    var inicioX = 0, inicioY = 0;
    objetos = [];
    flechas = [];

    function actualizar() {
      cx.fillStyle = '#f0f0f0';
      cx.fillRect(0, 0, 1000, 800);
      cx.font = "12px sans-serif";
      cx.fillStyle="black";
      for (var i = 0; i < objetos.length; i++) {
        if(objetos[i].tipo=='proceso'){
          cx.beginPath();
          cx.strokeRect(objetos[i].x, objetos[i].y, objetos[i].width, objetos[i].height);
          cx.fillText(objetos[i].texto,objetos[i].x+10,objetos[i].y+(objetos[i].height/2));
          cx.closePath();
        }else if(objetos[i].tipo=='limites'){
          cx.beginPath();
          cx.arc(objetos[i].x, objetos[i].y, objetos[i].width/2, 0, Math.PI*2, false);
          cx.fillText(objetos[i].texto,objetos[i].x-(objetos[i].width/2)+40,objetos[i].y);
          cx.stroke();
          cx.closePath();
        }else if(objetos[i].tipo=='decision'){
          cx.beginPath();
          cx.moveTo(objetos[i].x, objetos[i].y);
          cx.lineTo((objetos[i].width/2)+objetos[i].x, objetos[i].y+(objetos[i].height/2));
          cx.lineTo(objetos[i].x, objetos[i].y+objetos[i].height);
          cx.lineTo(objetos[i].x-(objetos[i].width/2), objetos[i].y+(objetos[i].height/2));
          cx.fillText(objetos[i].texto,objetos[i].x-(objetos[i].width/2)+10,objetos[i].y+(objetos[i].height/2)+5);
          cx.closePath();
          cx.stroke();
        }else if(objetos[i].tipo=='entradaSalida'){
          cx.beginPath();
          cx.moveTo(objetos[i].x, objetos[i].y);
          cx.lineTo(objetos[i].x+objetos[i].width, objetos[i].y);
          cx.lineTo(objetos[i].x+objetos[i].width-20, objetos[i].y+objetos[i].height);
          cx.lineTo(objetos[i].x-20, objetos[i].y+objetos[i].height);
          cx.fillText(objetos[i].texto,objetos[i].x,objetos[i].y+(objetos[i].height/2));
          cx.closePath();
          cx.stroke();
        }
      }
      for (var i = 0; i < flechas.length; i++) {
        if(objetos[flechas[i].desde].tipo=='proceso'){
          cx.beginPath();
          cx.moveTo(objetos[flechas[i].desde].x+(objetos[flechas[i].desde].width/2), objetos[flechas[i].desde].y+objetos[flechas[i].desde].height);
        }else if(objetos[flechas[i].desde].tipo=='limites'){
          cx.beginPath();
          cx.moveTo(objetos[flechas[i].desde].x, objetos[flechas[i].desde].y+(objetos[flechas[i].desde].width/2));
        }else if(objetos[flechas[i].desde].tipo=='decision'){
          if(flechas[i].txt=='Si'){
            cx.beginPath();
            cx.moveTo(objetos[flechas[i].desde].x, objetos[flechas[i].desde].y+objetos[flechas[i].desde].height);
            cx.fillText('Si',objetos[flechas[i].desde].x+10,objetos[flechas[i].desde].y+objetos[flechas[i].desde].height+10);
          }else{
            cx.beginPath();
            cx.moveTo(objetos[flechas[i].desde].x+(objetos[flechas[i].desde].width/2), objetos[flechas[i].desde].y+(objetos[flechas[i].desde].height/2));
            cx.fillText('No',objetos[flechas[i].desde].x+(objetos[flechas[i].desde].width/2)+10,objetos[flechas[i].desde].y+(objetos[flechas[i].desde].height/2)-10);
          }
        }else if(objetos[flechas[i].desde].tipo=='entradaSalida'){
          cx.beginPath();
          cx.moveTo(objetos[flechas[i].desde].x-20+(objetos[flechas[i].desde].width/2), objetos[flechas[i].desde].y+objetos[flechas[i].desde].height);
        }

        if(objetos[flechas[i].hasta].tipo=='proceso'){
          cx.lineTo(objetos[flechas[i].hasta].x+(objetos[flechas[i].desde].width/2), objetos[flechas[i].hasta].y);
          cx.lineTo(objetos[flechas[i].hasta].x+(objetos[flechas[i].desde].width/2)+5, objetos[flechas[i].hasta].y-5);
          cx.lineTo(objetos[flechas[i].hasta].x+(objetos[flechas[i].desde].width/2)-5, objetos[flechas[i].hasta].y-5);
          cx.lineTo(objetos[flechas[i].hasta].x+(objetos[flechas[i].desde].width/2), objetos[flechas[i].hasta].y);
          cx.closePath();
          cx.stroke();
        }else if(objetos[flechas[i].hasta].tipo=='limites'){
          cx.lineTo(objetos[flechas[i].hasta].x, objetos[flechas[i].hasta].y-(objetos[flechas[i].hasta].width/2));
          cx.lineTo(objetos[flechas[i].hasta].x+5, objetos[flechas[i].hasta].y-(objetos[flechas[i].hasta].width/2)-5);
          cx.lineTo(objetos[flechas[i].hasta].x-5, objetos[flechas[i].hasta].y-(objetos[flechas[i].hasta].width/2)-5);
          cx.lineTo(objetos[flechas[i].hasta].x, objetos[flechas[i].hasta].y-(objetos[flechas[i].hasta].width/2));
          cx.closePath();
          cx.stroke();
        }else if(objetos[flechas[i].hasta].tipo=='decision'){
          cx.lineTo(objetos[flechas[i].hasta].x, objetos[flechas[i].hasta].y);
          cx.lineTo(objetos[flechas[i].hasta].x+5, objetos[flechas[i].hasta].y-5);
          cx.lineTo(objetos[flechas[i].hasta].x-5, objetos[flechas[i].hasta].y-5);
          cx.lineTo(objetos[flechas[i].hasta].x, objetos[flechas[i].hasta].y);
          cx.closePath();
          cx.stroke();
        }else if(objetos[flechas[i].hasta].tipo=='entradaSalida'){
          cx.lineTo(objetos[flechas[i].hasta].x+(objetos[flechas[i].desde].width/2), objetos[flechas[i].hasta].y);
          cx.lineTo(objetos[flechas[i].hasta].x+(objetos[flechas[i].desde].width/2)+5, objetos[flechas[i].hasta].y-5);
          cx.lineTo(objetos[flechas[i].hasta].x+(objetos[flechas[i].desde].width/2)-5, objetos[flechas[i].hasta].y-5);
          cx.lineTo(objetos[flechas[i].hasta].x+(objetos[flechas[i].desde].width/2), objetos[flechas[i].hasta].y);
          cx.closePath();
          cx.stroke();
        }
      }
    }

    function prepararCamp(){
      document.getElementById('desde').value = '';
      document.getElementById('hacia').value = '';
      document.getElementById('tipoF').value = '';
      document.getElementById('texto').value = '';
      document.getElementById('posx').value = '';
      document.getElementById('posy').value = '';

      for (var i = 0; i < objetos.length; i++) {
        document.getElementById('tipoF').value += objetos[i].tipo+";";
        document.getElementById('texto').value += objetos[i].texto+";";
        document.getElementById('posx').value += objetos[i].x+";";
        document.getElementById('posy').value += objetos[i].y+";";
        document.getElementById('ids').value += i +";";
      }
      for (var i = 0; i < flechas.length; i++) {
        document.getElementById('desde').value += flechas[i].desde+";";
        document.getElementById('hacia').value += flechas[i].hasta+";";
      }
      document.getElementById('tipoF').value = document.getElementById('tipoF').value.substring(0,document.getElementById('tipoF').value.length-1);
      document.getElementById('texto').value = document.getElementById('texto').value.substring(0,document.getElementById('texto').value.length-1);
      document.getElementById('posx').value = document.getElementById('posx').value.substring(0,document.getElementById('posx').value.length-1);
      document.getElementById('posy').value = document.getElementById('posy').value.substring(0,document.getElementById('posy').value.length-1);
      document.getElementById('ids').value = document.getElementById('ids').value.substring(0,document.getElementById('ids').value.length-1);
      document.getElementById('desde').value = document.getElementById('desde').value.substring(0,document.getElementById('desde').value.length-1);
      document.getElementById('hacia').value = document.getElementById('hacia').value.substring(0,document.getElementById('hacia').value.length-1);
    }

    function addFig(){
      let forma = document.getElementById('forma').value;
      let txtFig = document.getElementById('textoFig').value;
      objetos.push({
        x:100,y:100,
        height:80,
        width:120,
        tipo:forma,
        texto:txtFig
      })
      actualizar();
    }

    function addArrow(){
      valorFle = document.getElementById('valorFl').value;
      flecha = true;
    }

    window.onload = function() {
      cv = document.getElementById('lienzo');
      cx = cv.getContext('2d');


      cv.onmousedown = function(event) {
        if(flecha){
          if(elem1==-1){
            for (var i = 0; i < objetos.length; i++) {
              if(objetos[i].tipo=='proceso'){
                if (objetos[i].x < event.clientX
                  && (objetos[i].width + objetos[i].x > event.clientX)
                  && objetos[i].y < event.clientY
                  && (objetos[i].height + objetos[i].y > event.clientY)
                ) {
                  elem1=i;
                  break;
                }
              }else if(objetos[i].tipo=='limites'){
                if (objetos[i].x-(objetos[i].width/2) < event.clientX
                  && (objetos[i].x + (objetos[i].width/2) > event.clientX)
                  && objetos[i].y-(objetos[i].width/2) < event.clientY
                  && ((objetos[i].width/2) + objetos[i].y > event.clientY)
                ) {
                  elem1=i;
                  break;
                }
              }else if(objetos[i].tipo=='decision'){
                if ((objetos[i].x-(objetos[i].width/2)) < event.clientX
                  && ((objetos[i].width/2) + objetos[i].x > event.clientX)
                  && objetos[i].y < event.clientY
                  && (objetos[i].height + objetos[i].y > event.clientY)
                ) {
                  elem1=i;
                  break;
                }
              }else if(objetos[i].tipo=='entradaSalida'){
                if ((objetos[i].x-20) < event.clientX
                  && (objetos[i].width + objetos[i].x > event.clientX)
                  && objetos[i].y < event.clientY
                  && (objetos[i].height + objetos[i].y > event.clientY)
                ) {
                  elem1=i;
                  break;
                }
              }
            }
          }else{
            for (var i = 0; i < objetos.length; i++) {
              if(objetos[i].tipo=='proceso'){
                if (objetos[i].x < event.clientX
                  && (objetos[i].width + objetos[i].x > event.clientX)
                  && objetos[i].y < event.clientY
                  && (objetos[i].height + objetos[i].y > event.clientY)
                ) {
                  elem2=i;
                  break;
                }
              }else if(objetos[i].tipo=='limites'){
                if (objetos[i].x-(objetos[i].width/2) < event.clientX
                  && (objetos[i].x + (objetos[i].width/2) > event.clientX)
                  && objetos[i].y-(objetos[i].width/2) < event.clientY
                  && ((objetos[i].width/2) + objetos[i].y > event.clientY)
                ) {
                  elem2=i;
                  break;
                }
              }else if(objetos[i].tipo=='decision'){
                if ((objetos[i].x-(objetos[i].width/2)) < event.clientX
                  && ((objetos[i].width/2) + objetos[i].x > event.clientX)
                  && objetos[i].y < event.clientY
                  && (objetos[i].height + objetos[i].y > event.clientY)
                ) {
                  elem2=i;
                  break;
                }
              }else if(objetos[i].tipo=='entradaSalida'){
                if ((objetos[i].x-20) < event.clientX
                  && (objetos[i].width + objetos[i].x > event.clientX)
                  && objetos[i].y < event.clientY
                  && (objetos[i].height + objetos[i].y > event.clientY)
                ) {
                  elem2=i;
                  break;
                }
              }
            }
            flechas.push({
              desde:elem1,
              hasta:elem2,
              txt:valorFle
            });
            elem1=-1;
            elem2=-1;
            flecha = false;
          }
        }else{
          for (var i = 0; i < objetos.length; i++) {
            if(objetos[i].tipo=='proceso'){
              if (objetos[i].x < event.clientX
                && (objetos[i].width + objetos[i].x > event.clientX)
                && objetos[i].y < event.clientY
                && (objetos[i].height + objetos[i].y > event.clientY)
              ) {
                objetoActual = objetos[i];
                inicioY = event.clientY - objetos[i].y;
                inicioX = event.clientX - objetos[i].x;
                break;
              }
            }else if(objetos[i].tipo=='limites'){
              if (objetos[i].x-(objetos[i].width/2) < event.clientX
                && (objetos[i].x + (objetos[i].width/2) > event.clientX)
                && objetos[i].y-(objetos[i].width/2) < event.clientY
                && ((objetos[i].width/2) + objetos[i].y > event.clientY)
              ) {
                objetoActual = objetos[i];
                inicioY = event.clientY - objetos[i].y;
                inicioX = event.clientX - objetos[i].x;
                break;
              }
            }else if(objetos[i].tipo=='decision'){
              if ((objetos[i].x-(objetos[i].width/2)) < event.clientX
                && ((objetos[i].width/2) + objetos[i].x > event.clientX)
                && objetos[i].y < event.clientY
                && (objetos[i].height + objetos[i].y > event.clientY)
              ) {
                objetoActual = objetos[i];
                inicioY = event.clientY - objetos[i].y;
                inicioX = event.clientX - objetos[i].x;
                break;
              }
            }else if(objetos[i].tipo=='entradaSalida'){
              if ((objetos[i].x-20) < event.clientX
                && (objetos[i].width + objetos[i].x > event.clientX)
                && objetos[i].y < event.clientY
                && (objetos[i].height + objetos[i].y > event.clientY)
              ) {
                objetoActual = objetos[i];
                inicioY = event.clientY - objetos[i].y;
                inicioX = event.clientX - objetos[i].x;
                break;
              }
            }
          }
        }
      }

      cv.onmousemove = function(event) {
        if (objetoActual != null) {
          objetoActual.x = event.clientX - inicioX;
          objetoActual.y = event.clientY - inicioY;
        }
        actualizar();
      }

      cv.onmouseup = function(evet) {
        objetoActual = null;
      }
    }
  </script>
</body>
</html>